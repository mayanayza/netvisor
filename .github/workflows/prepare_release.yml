name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.11.3)'
        required: true
        type: string

permissions: {}

jobs:
  prepare-release:
    name: Bump Version and Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: dev
        fetch-depth: 0
    
    - name: Validate version format
      run: |
        if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå Invalid version format. Use semver (e.g., 0.11.3)"
          exit 1
        fi
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@1.90.0
    
    - name: Update version in Cargo.toml and package.json
      run: |
        VERSION="${{ inputs.version }}"
        
        echo "Current Cargo.toml version:"
        grep "^version" backend/Cargo.toml | head -1
        
        # Update backend/Cargo.toml
        sed -i "s/^version = .*/version = \"$VERSION\"/" backend/Cargo.toml
        
        echo "Updated Cargo.toml version:"
        grep "^version" backend/Cargo.toml | head -1
        
        # Update Cargo.lock
        cd backend && cargo check --quiet && cd ..
        
        # Update ui/package.json
        cd ui
        npm version $VERSION --no-git-tag-version --allow-same-version
        cd ..
    
    - name: Commit version bump
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add backend/Cargo.toml backend/Cargo.lock ui/package.json ui/package-lock.json
        
        if git diff --staged --quiet; then
          echo "Version already at ${{ inputs.version }}, skipping commit"
        else
          git commit -m "chore: bump version to ${{ inputs.version }}"
          git push origin dev
        fi
    - name: Create release
      run: |
        gh release create "v${{ inputs.version }}" \
          --title "v${{ inputs.version }}" \
          --generate-notes \
          --prerelease \
          --target dev
      env:
        GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
