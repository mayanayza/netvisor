name: Discord Release Notification

on:
  release:
    types: [released]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.RELEASE_CHANNEL_WEBHOOK }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          BODY="${RELEASE_BODY:0:4000}"
          if [ ${#RELEASE_BODY} -gt 4000 ]; then
            BODY="${BODY}...\n\n[Read full release notes](${RELEASE_URL})"
          fi
          
          # Escape special characters for JSON
          BODY=$(echo "$BODY" | jq -Rs .)
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸš€ ${RELEASE_NAME}\",
                \"url\": \"${RELEASE_URL}\",
                \"description\": ${BODY},
                \"color\": 5814783,
                \"fields\": [{
                  \"name\": \"Version\",
                  \"value\": \"\`${RELEASE_TAG}\`\",
                  \"inline\": true
                }],
                \"footer\": {
                  \"text\": \"NetVisor Release\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"